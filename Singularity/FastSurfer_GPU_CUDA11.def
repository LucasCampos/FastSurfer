Bootstrap: docker
From: nvidia/cuda:11.0-cudnn8-runtime-ubuntu16.04
Stage: build

%post
# Install custom libraries + freesurfer 6.0 (and necessary dependencies)
    export PYTHON_VERSION=3.6
    apt-get update && apt-get install -y --no-install-recommends \
         build-essential \
         cmake \
         git \
         vim \
         wget \
         ca-certificates \
         bzip2 \
         libx11-6 \
         libjpeg-dev \
         libpng-dev \
         bc \
         tar \
         zip \
         gawk \
         tcsh \
         time \
         wget \
         libgomp1 \
         libglu1-mesa \
	 libglu1-mesa-dev \
	 perl-modules && \
         apt-get clean && \

    # Install miniconda and needed python packages (for FastSurferCNN)
    wget -qO ~/miniconda.sh https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh  && \
     chmod +x ~/miniconda.sh && \
     ~/miniconda.sh -b -p /opt/conda && \
     rm ~/miniconda.sh && \
     /opt/conda/bin/conda install -y python=$PYTHON_VERSION numpy scipy matplotlib h5py scikit-image && \
     /opt/conda/bin/conda install -y pytorch torchvision torchaudio cudatoolkit=11.0 -c pytorch -y && \
     /opt/conda/bin/conda install -y -c conda-forge scikit-sparse nibabel=2.5.1 pillow=7.1.1 && \
     /opt/conda/bin/conda clean -ya

    # Install FreeSurfer
    wget -qO- https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.1/freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.1.tar.gz | tar zxv --no-same-owner -C /opt \
        --exclude='freesurfer/trctrain' \
        --exclude='freesurfer/subjects/fsaverage_sym' \
        --exclude='freesurfer/subjects/fsaverage3' \
        --exclude='freesurfer/subjects/fsaverage4' \
        --exclude='freesurfer/subjects/fsaverage5' \
        --exclude='freesurfer/subjects/fsaverage6' \
        --exclude='freesurfer/subjects/cvs_avg35' \
        --exclude='freesurfer/subjects/cvs_avg35_inMNI152' \
        --exclude='freesurfer/subjects/bert' \
        --exclude='freesurfer/subjects/V1_average' \
        --exclude='freesurfer/average/mult-comp-cor' \
        --exclude='freesurfer/lib/cuda' \
        --exclude='freesurfer/lib/qt'
 
%environment
    export PATH=/opt/conda/bin:$PATH
    # Add FreeSurfer Environment variables (.license file needed, alternatively export FS_LICENSE=path/to/license)
    export OS=Linux 
    export FS_OVERRIDE=0 
    export FIX_VERTEX_AREA= 
    export SUBJECTS_DIR=/opt/freesurfer/subjects 
    export FSF_OUTPUT_FORMAT=nii.gz 
    export MNI_DIR=/opt/freesurfer/mni 
    export LOCAL_DIR=/opt/freesurfer/local 
    export FREESURFER_HOME=/opt/freesurfer 
    export FSFAST_HOME=/opt/freesurfer/fsfast 
    export MINC_BIN_DIR=/opt/freesurfer/mni/bin 
    export MINC_LIB_DIR=/opt/freesurfer/mni/lib 
    export MNI_DATAPATH=/opt/freesurfer/mni/data 
    export FMRI_ANALYSIS_DIR=/opt/freesurfer/fsfast 
    export PERL5LIB=/opt/freesurfer/mni/lib/perl5/5.8.5 
    export MNI_PERL5LIB=/opt/freesurfer/mni/lib/perl5/5.8.5 
    export PYTHONUNBUFFERED=0 
    export PATH=/opt/freesurfer/bin:/opt/freesurfer/fsfast/bin:/opt/freesurfer/tktools:/opt/freesurfer/mni/bin:$PATH

%files 
    . /fastsurfer 

%runscript
    echo "Container was created $NOW"
    echo "Arguments received: $*"
    cd /fastsurfer
    exec bash ./run_fastsurfer.sh "$@"


%labels
    Author LQCC
    Version v0.0.1

%help
    This is a demo container used to illustrate a def file that uses all
    supported sections.
